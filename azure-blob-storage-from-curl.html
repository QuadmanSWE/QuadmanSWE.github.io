<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Azure blob storage from curl</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/atom+xml" href="/feed.xml">
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <h1>blog.dsoderlund.consulting</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>

    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Azure blob storage from curl</h2>
  <time datetime="2024-04-28T00:00:00+00:00" class="by-line">28 Apr 2024</time>
  <h1 id="upload-large-files-from-tiny-devices-to-azure-blob-storage">Upload large files from tiny devices to Azure blob storage</h1>

<p>This week I got to work on something a bit different from my normal wheel house.</p>

<p>I published <a href="https://github.com/QuadmanSWE/curl-blob">my source code here</a> including examples for different auth schemes and different mechanisms of invokation</p>

<!--more-->

<h2 id="scope">Scope</h2>

<p>The customer needed some fast help in solving how to upload files mounted on a device with limited RAM and very little maneuverability when it comes to adding software.</p>

<p>The limitations on the hardware specs posed the question:</p>

<p>Could we do it with just curl?</p>

<p>We briefly looked at something like scp but couldn’t in time produce a binary that fit the CPU architecture.</p>

<p>So we ran with what we had: dd, curl and parts of openssl for cryptographic signing.</p>

<h2 id="making-plans">Making plans</h2>

<p>First I drew up how I wanted to interact with the software and what I know you need to interact with the Azure Blob Storage API.</p>

<ul>
  <li>Accountname</li>
  <li>Credentials</li>
  <li>Container name</li>
  <li>Blob patch</li>
  <li>Local path</li>
</ul>

<p>I knew I wanted to be able to run it in a docker container for testing to make sure I wasn’t tricked by running on windows or wsl.</p>

<p>Quick and dirty, get alpine, add openssl and curl, call a shell script to make it happen once you mount the file you want to upload, let’s go.</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> alpine</span>
<span class="k">RUN </span>apk add <span class="nt">--no-cache</span> curl openssl
<span class="k">COPY</span><span class="s"> upload.sh /upload.sh</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["/bin/sh", "/upload.sh"]</span>
</code></pre></div></div>

<h2 id="first-prototype">First prototype</h2>

<p>Github Copilot was friendly enough to get me started on a shell script that could perform the steps. But it was a tripped up by different versions in the API docs so I had to make some corrections.</p>

<p><a href="https://learn.microsoft.com/en-us/rest/api/storageservices/put-blob">Documentation on rest PUT blob from Microsoft</a></p>

<p>Here is our first attempt to get a file to a blob storage container in one pass.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="c"># upload.sh</span>
<span class="nb">set</span> <span class="nt">-e</span>
<span class="c"># Arguments</span>
<span class="nv">STORAGE_ACCOUNT_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">STORAGE_ACCOUNT_NAME</span><span class="k">:-</span><span class="nv">$1</span><span class="k">}</span>
<span class="nv">STORAGE_ACCOUNT_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">STORAGE_ACCOUNT_KEY</span><span class="k">:-</span><span class="nv">$2</span><span class="k">}</span>
<span class="nv">STORAGE_CONTAINER</span><span class="o">=</span><span class="k">${</span><span class="nv">STORAGE_CONTAINER</span><span class="k">:-</span><span class="nv">$3</span><span class="k">}</span>
<span class="nv">BLOB_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">BLOB_PATH</span><span class="k">:-</span><span class="nv">$4</span><span class="k">}</span>
<span class="nv">FILE_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">FILE_PATH</span><span class="k">:-</span><span class="nv">$5</span><span class="k">}</span>

<span class="c"># Signing key</span>
<span class="nv">decoded_hex_key</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="nv">$STORAGE_ACCOUNT_KEY</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="nt">-w0</span> | xxd <span class="nt">-p</span> <span class="nt">-c256</span><span class="si">)</span><span class="s2">"</span>

<span class="nv">BLOB_LENGTH</span><span class="o">=</span><span class="si">$(</span><span class="nb">wc</span> <span class="nt">-c</span> &lt;<span class="nv">$FILE_PATH</span><span class="si">)</span>
<span class="nv">BLOB_TYPE</span><span class="o">=</span><span class="s2">"BlockBlob"</span>

<span class="c"># Construct the URL</span>
<span class="nv">URL</span><span class="o">=</span><span class="s2">"https://</span><span class="k">${</span><span class="nv">STORAGE_ACCOUNT_NAME</span><span class="k">}</span><span class="s2">.blob.core.windows.net/</span><span class="k">${</span><span class="nv">STORAGE_CONTAINER</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">BLOB_PATH</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># Generate the headers</span>
<span class="nv">DATE_VALUE</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-u</span> +<span class="s2">"%a, %d %b %Y %H:%M:%S GMT"</span><span class="si">)</span>
<span class="nv">STORAGE_SERVICE_VERSION</span><span class="o">=</span><span class="s2">"2019-12-12"</span>
<span class="c"># Construct the CanonicalizedResource</span>
<span class="nv">CANONICALIZED_RESOURCE</span><span class="o">=</span><span class="s2">"/</span><span class="k">${</span><span class="nv">STORAGE_ACCOUNT_NAME</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">STORAGE_CONTAINER</span><span class="k">}</span><span class="s2">/</span><span class="k">${</span><span class="nv">BLOB_PATH</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># Construct the CanonicalizedHeaders</span>
<span class="nv">CANONICALIZED_HEADERS</span><span class="o">=</span><span class="s2">"x-ms-blob-type:</span><span class="k">${</span><span class="nv">BLOB_TYPE</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-date:</span><span class="k">${</span><span class="nv">DATE_VALUE</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-version:</span><span class="k">${</span><span class="nv">STORAGE_SERVICE_VERSION</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># Generate the signature</span>
<span class="nv">STRING_TO_SIGN</span><span class="o">=</span><span class="s2">"PUT</span><span class="se">\n\n\n</span><span class="k">${</span><span class="nv">BLOB_LENGTH</span><span class="k">}</span><span class="se">\n\n\n\n\n\n\n\n\n</span><span class="k">${</span><span class="nv">CANONICALIZED_HEADERS</span><span class="k">}</span><span class="se">\n</span><span class="k">${</span><span class="nv">CANONICALIZED_RESOURCE</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">SIGNATURE</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"</span><span class="nv">$STRING_TO_SIGN</span><span class="s2">"</span> | openssl dgst <span class="nt">-sha256</span> <span class="nt">-mac</span> HMAC <span class="nt">-macopt</span> <span class="s2">"hexkey:</span><span class="nv">$decoded_hex_key</span><span class="s2">"</span> <span class="nt">-binary</span> | <span class="nb">base64</span> <span class="nt">-w0</span><span class="si">)</span>
<span class="nv">AUTHORIZATION_HEADER</span><span class="o">=</span><span class="s2">"SharedKey </span><span class="k">${</span><span class="nv">STORAGE_ACCOUNT_NAME</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span><span class="s2">"</span>
<span class="c"># Upload the file</span>
curl <span class="nt">-X</span> PUT <span class="nt">-T</span> <span class="s2">"</span><span class="k">${</span><span class="nv">FILE_PATH</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"x-ms-blob-type: </span><span class="k">${</span><span class="nv">BLOB_TYPE</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"x-ms-date: </span><span class="k">${</span><span class="nv">DATE_VALUE</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"x-ms-version: </span><span class="k">${</span><span class="nv">STORAGE_SERVICE_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="k">${</span><span class="nv">AUTHORIZATION_HEADER</span><span class="k">}</span><span class="s2">"</span> <span class="k">${</span><span class="nv">URL</span><span class="k">}</span>
<span class="c"># Terminate</span>
<span class="nb">exit </span>0
</code></pre></div></div>

<p>This worked well, the construction of the arguments were a bit finicky but we got there pretty quick. The error messages from the api were very helpful most of the time.</p>

<p>The authentication mechanism is that you sign the request (length, headers, resource) that you are using such that you prove that you have access to the private key to the storage account and that you want to perform the exact operation matching the signature. The API will do the same operation and compare the signatures.</p>

<h2 id="what-if-the-files-dont-fit-in-ram">What if the files don’t fit in RAM?</h2>

<p>Right, hardware specs.</p>

<p>We came up with the idea of striping the files and uploading them one by one, but quickly found that Azure supports incremental uploads to a Append Blob.</p>

<p>Using dd to get the exact right chunk of data and piping it into curl.</p>

<p>Here was our resulting scheme, note that we need to sign each request to upload another block / chunk.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">##### removed for brevity</span>
<span class="nv">CHUNK_SIZE</span><span class="o">=</span><span class="k">${</span><span class="nv">CHUNK_SIZE</span><span class="k">:-</span><span class="nv">$6</span><span class="k">}</span>
<span class="c"># Figures out if CHUNK_SIZE is null in which case we always to a single blob upload</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$CHUNK_SIZE</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">CHUNK_SIZE</span><span class="o">=</span><span class="nv">$BLOB_LENGTH</span>
<span class="k">fi

if</span> <span class="o">[</span> <span class="nv">$BLOB_LENGTH</span> <span class="nt">-le</span> <span class="nv">$CHUNK_SIZE</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c">##### Previous example, removed for brevity</span>
    <span class="nb">exit </span>0
<span class="k">else</span>
    <span class="c"># empty append blob</span>
    <span class="nv">CONTENT_TYPE</span><span class="o">=</span><span class="s2">"application/octet-stream"</span>
    <span class="nv">BLOB_TYPE</span><span class="o">=</span><span class="s2">"AppendBlob"</span>
    <span class="nv">CANONICALIZED_HEADERS</span><span class="o">=</span><span class="s2">"x-ms-blob-type:</span><span class="k">${</span><span class="nv">BLOB_TYPE</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-date:</span><span class="k">${</span><span class="nv">DATE_VALUE</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-version:</span><span class="k">${</span><span class="nv">STORAGE_SERVICE_VERSION</span><span class="k">}</span><span class="s2">"</span>
    <span class="nv">STRING_TO_SIGN</span><span class="o">=</span><span class="s2">"PUT</span><span class="se">\n\n\n\n\n</span><span class="k">${</span><span class="nv">CONTENT_TYPE</span><span class="k">}</span><span class="se">\n\n\n\n\n\n\n</span><span class="k">${</span><span class="nv">CANONICALIZED_HEADERS</span><span class="k">}</span><span class="se">\n</span><span class="k">${</span><span class="nv">CANONICALIZED_RESOURCE</span><span class="k">}</span><span class="s2">"</span>
    <span class="nv">SIGNATURE</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"</span><span class="nv">$STRING_TO_SIGN</span><span class="s2">"</span> | openssl dgst <span class="nt">-sha256</span> <span class="nt">-mac</span> HMAC <span class="nt">-macopt</span> <span class="s2">"hexkey:</span><span class="nv">$decoded_hex_key</span><span class="s2">"</span> <span class="nt">-binary</span> | <span class="nb">base64</span> <span class="nt">-w0</span><span class="si">)</span>
    <span class="nv">AUTHORIZATION_HEADER</span><span class="o">=</span><span class="s2">"SharedKey </span><span class="k">${</span><span class="nv">STORAGE_ACCOUNT_NAME</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span><span class="s2">"</span>
    <span class="c"># Create an empty append blob</span>
    curl <span class="nt">-X</span> PUT <span class="nt">-H</span> <span class="s2">"Content-Type: </span><span class="k">${</span><span class="nv">CONTENT_TYPE</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"Content-Length: 0"</span> <span class="nt">-H</span> <span class="s2">"x-ms-blob-type: </span><span class="k">${</span><span class="nv">BLOB_TYPE</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"x-ms-date: </span><span class="k">${</span><span class="nv">DATE_VALUE</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"x-ms-version: </span><span class="k">${</span><span class="nv">STORAGE_SERVICE_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="k">${</span><span class="nv">AUTHORIZATION_HEADER</span><span class="k">}</span><span class="s2">"</span> <span class="k">${</span><span class="nv">URL</span><span class="k">}</span>
end

<span class="c"># Upload the file in chunks</span>
<span class="nv">OFFSET</span><span class="o">=</span>0
<span class="nv">CHUNK_NUMBER</span><span class="o">=</span>0
<span class="nv">URL</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">URL</span><span class="k">}</span><span class="s2">?comp=appendblock"</span>

<span class="k">while</span> <span class="o">[</span> <span class="k">$((</span><span class="nv">$OFFSET</span> <span class="o">+</span> <span class="nv">$CHUNK_SIZE</span><span class="k">))</span> <span class="nt">-le</span> <span class="nv">$BLOB_LENGTH</span> <span class="o">]</span><span class="p">;</span> <span class="k">do
    </span><span class="nv">CANONICALIZED_HEADERS</span><span class="o">=</span><span class="s2">"x-ms-blob-condition-appendpos:</span><span class="k">${</span><span class="nv">OFFSET</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-blob-condition-maxsize:</span><span class="k">${</span><span class="nv">BLOB_LENGTH</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-date:</span><span class="k">${</span><span class="nv">DATE_VALUE</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-version:</span><span class="k">${</span><span class="nv">STORAGE_SERVICE_VERSION</span><span class="k">}</span><span class="s2">"</span>
    <span class="nv">STRING_TO_SIGN</span><span class="o">=</span><span class="s2">"PUT</span><span class="se">\n\n\n</span><span class="k">${</span><span class="nv">CHUNK_SIZE</span><span class="k">}</span><span class="se">\n\n</span><span class="k">${</span><span class="nv">CONTENT_TYPE</span><span class="k">}</span><span class="se">\n\n\n\n\n\n\n</span><span class="k">${</span><span class="nv">CANONICALIZED_HEADERS</span><span class="k">}</span><span class="se">\n</span><span class="k">${</span><span class="nv">CANONICALIZED_RESOURCE</span><span class="k">}</span><span class="se">\n</span><span class="s2">comp:appendblock"</span>
    <span class="nv">SIGNATURE</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"</span><span class="nv">$STRING_TO_SIGN</span><span class="s2">"</span> | openssl dgst <span class="nt">-sha256</span> <span class="nt">-mac</span> HMAC <span class="nt">-macopt</span> <span class="s2">"hexkey:</span><span class="nv">$decoded_hex_key</span><span class="s2">"</span> <span class="nt">-binary</span> | <span class="nb">base64</span> <span class="nt">-w0</span><span class="si">)</span>
    <span class="nv">AUTHORIZATION_HEADER</span><span class="o">=</span><span class="s2">"SharedKey </span><span class="k">${</span><span class="nv">STORAGE_ACCOUNT_NAME</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span><span class="s2">"</span>
    <span class="nb">dd </span><span class="k">if</span><span class="o">=</span><span class="nv">$FILE_PATH</span> <span class="nv">bs</span><span class="o">=</span><span class="nv">$CHUNK_SIZE</span> <span class="nv">count</span><span class="o">=</span>1 <span class="nv">skip</span><span class="o">=</span><span class="nv">$CHUNK_NUMBER</span> 2&gt;/dev/null |
        curl <span class="nt">-m</span> 2 <span class="nt">-X</span> PUT <span class="nt">--data-binary</span> @- <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"Content-Type: </span><span class="k">${</span><span class="nv">CONTENT_TYPE</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"Content-Length: </span><span class="nv">$CHUNK_SIZE</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"x-ms-blob-condition-maxsize: </span><span class="k">${</span><span class="nv">BLOB_LENGTH</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"x-ms-blob-condition-appendpos: </span><span class="k">${</span><span class="nv">OFFSET</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"x-ms-date: </span><span class="k">${</span><span class="nv">DATE_VALUE</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"x-ms-version: </span><span class="k">${</span><span class="nv">STORAGE_SERVICE_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="k">${</span><span class="nv">AUTHORIZATION_HEADER</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="s2">"</span><span class="k">${</span><span class="nv">URL</span><span class="k">}</span><span class="s2">"</span>
    <span class="nv">OFFSET</span><span class="o">=</span><span class="k">$((</span><span class="nv">$OFFSET</span> <span class="o">+</span> <span class="nv">$CHUNK_SIZE</span><span class="k">))</span>
    <span class="nv">CHUNK_NUMBER</span><span class="o">=</span><span class="k">$((</span><span class="nv">$CHUNK_NUMBER</span> <span class="o">+</span> <span class="m">1</span><span class="k">))</span>
<span class="k">done</span>
<span class="c"># ...</span>
</code></pre></div></div>

<p>This works super well as long as the chunks align with the entire blob size.
More often than not of course we will find that it doesn’t, so we just calculate the last chunk size with modulo.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ... continuing on </span>
<span class="nv">LAST_CHUNK_SIZE</span><span class="o">=</span><span class="k">$((</span><span class="nv">$BLOB_LENGTH</span> <span class="o">%</span> <span class="nv">$CHUNK_SIZE</span><span class="k">))</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$LAST_CHUNK_SIZE</span> <span class="nt">-gt</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">CANONICALIZED_HEADERS</span><span class="o">=</span><span class="s2">"x-ms-blob-condition-appendpos:</span><span class="k">${</span><span class="nv">OFFSET</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-blob-condition-maxsize:</span><span class="k">${</span><span class="nv">BLOB_LENGTH</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-date:</span><span class="k">${</span><span class="nv">DATE_VALUE</span><span class="k">}</span><span class="se">\n</span><span class="s2">x-ms-version:</span><span class="k">${</span><span class="nv">STORAGE_SERVICE_VERSION</span><span class="k">}</span><span class="s2">"</span>
    <span class="nv">STRING_TO_SIGN</span><span class="o">=</span><span class="s2">"PUT</span><span class="se">\n\n\n</span><span class="k">${</span><span class="nv">LAST_CHUNK_SIZE</span><span class="k">}</span><span class="se">\n\n</span><span class="k">${</span><span class="nv">CONTENT_TYPE</span><span class="k">}</span><span class="se">\n\n\n\n\n\n\n</span><span class="k">${</span><span class="nv">CANONICALIZED_HEADERS</span><span class="k">}</span><span class="se">\n</span><span class="k">${</span><span class="nv">CANONICALIZED_RESOURCE</span><span class="k">}</span><span class="se">\n</span><span class="s2">comp:appendblock"</span>
    <span class="nv">SIGNATURE</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s2">"</span><span class="nv">$STRING_TO_SIGN</span><span class="s2">"</span> | openssl dgst <span class="nt">-sha256</span> <span class="nt">-mac</span> HMAC <span class="nt">-macopt</span> <span class="s2">"hexkey:</span><span class="nv">$decoded_hex_key</span><span class="s2">"</span> <span class="nt">-binary</span> | <span class="nb">base64</span> <span class="nt">-w0</span><span class="si">)</span>
    <span class="nv">AUTHORIZATION_HEADER</span><span class="o">=</span><span class="s2">"SharedKey </span><span class="k">${</span><span class="nv">STORAGE_ACCOUNT_NAME</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span><span class="s2">"</span>
    <span class="nb">dd </span><span class="k">if</span><span class="o">=</span><span class="nv">$FILE_PATH</span> <span class="nv">bs</span><span class="o">=</span><span class="nv">$CHUNK_SIZE</span> <span class="nv">count</span><span class="o">=</span>1 <span class="nv">skip</span><span class="o">=</span><span class="nv">$CHUNK_NUMBER</span> 2&gt;/dev/null |
        curl <span class="nt">-m</span> 2 <span class="nt">-X</span> PUT <span class="nt">--data-binary</span> @- <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"Content-Type: </span><span class="k">${</span><span class="nv">CONTENT_TYPE</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"Content-Length: </span><span class="nv">$LAST_CHUNK_SIZE</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"x-ms-blob-condition-maxsize: </span><span class="k">${</span><span class="nv">BLOB_LENGTH</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"x-ms-blob-condition-appendpos: </span><span class="k">${</span><span class="nv">OFFSET</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"x-ms-date: </span><span class="k">${</span><span class="nv">DATE_VALUE</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"x-ms-version: </span><span class="k">${</span><span class="nv">STORAGE_SERVICE_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="nt">-H</span> <span class="s2">"Authorization: </span><span class="k">${</span><span class="nv">AUTHORIZATION_HEADER</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
            <span class="s2">"</span><span class="k">${</span><span class="nv">URL</span><span class="k">}</span><span class="s2">"</span>
<span class="k">fi</span>
</code></pre></div></div>

<h2 id="distributing-signing-keys-to-an-entire-storage-account-might-not-scale-well-with-thousands-of-devices">Distributing signing keys to an entire storage account might not scale well with thousands of devices.</h2>

<p>The central solution that the devices help out has a bit more power and a lot more flexibilty in adding new software.</p>

<p>By generating SAS tokens for the places where each device will push their blobs, we can tailor and distribute those tokens rather easily.</p>

<p>It simplifies the authentication process greatly too.</p>

<p>Examples of using this auth mechanism can be found in the github repo linked at the top.</p>

<p>Cheers.</p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-sa/4.0">
    <span>
        <b>David Söderlund</b>
    </span>
    
    <span>© 2025</span>
  </a>
</footer>

  
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-263169605-1', 'auto');
  ga('send', 'pageview');
</script>
  
</body>

</html>
