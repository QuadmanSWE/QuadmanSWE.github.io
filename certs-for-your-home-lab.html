<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Automating homelab server certificate rotation</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/atom+xml" href="/feed.xml">
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <h1>blog.dsoderlund.consulting</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>

    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Automating homelab server certificate rotation</h2>
  <time datetime="2025-01-12T00:00:00+00:00" class="by-line">12 Jan 2025</time>
  <p>In this post I will show you how to use cronjobs in kubernetes to automate the updating of certificates from cert-manager to different servers in your local network.</p>

<!--more-->

<ul>
  <li>
<a href="#background">Background</a>
    <ul>
      <li><a href="#tell-me-where-do-certificates-come-from">Tell me, where do certificates come from?</a></li>
      <li><a href="#my-list-of-servers">My list of servers</a></li>
      <li><a href="#cron-jobs">Cron jobs</a></li>
    </ul>
  </li>
  <li>
<a href="#bringing-the-plan-to-life">Bringing the plan to life</a>
    <ul>
      <li><a href="#some-preparation">Some preparation</a></li>
      <li><a href="#the-certificate-request">The certificate request</a></li>
      <li>
<a href="#the-cron-jobs">The cron jobs</a>
        <ul>
          <li><a href="#certificate-files-through-ssh">Certificate files through ssh</a></li>
          <li><a href="#running-the-script">Running the script</a></li>
        </ul>
      </li>
      <li><a href="#proxmox-web-api">Proxmox web api</a></li>
      <li><a href="#the-final-result">The final result</a></li>
    </ul>
  </li>
</ul>

<h2 id="background">Background</h2>

<h3 id="tell-me-where-do-certificates-come-from">Tell me, where do certificates come from?</h3>

<p><a href="./the-joy-of-kubernetes-2-let-us-encrypt">In a previous post</a> we looked at how to use cert-manager to automate the creation of certificates from Let’s Encrypt. This is increadibly useful of course to slap on your ingress so that any traffic coming in is encrypted and that the user can trust that they have come to the right place.</p>

<p>But what if you want to use certificates outside of kubernetes, like for servers in your homelab or other equipment in your office?</p>

<h3 id="my-list-of-servers">My list of servers</h3>

<p>In my homelab I deal with a few different websites regularly and accepting the http warning every time I visit them is a bit of a nuisance.</p>

<p>I wanted to fix:</p>

<ul>
  <li>The router, running openwrt (uHTTPd)</li>
  <li>DNS server, running pi-hole (lighttpd)</li>
  <li>Synology NAS (nginx)</li>
  <li>Proxmox itself that my cluster runs on (has a great web api)</li>
</ul>

<h3 id="cron-jobs">Cron jobs</h3>

<p>Cron jobs let’s us schedule jobs to run on a regular basis. Jobs create pods which are expected to complete instead of keep running as is the case for deployments, statefulsets and daemonsets. These pods can have volumes mounted to them which is terrific since our certificates are already stored as secrets in kubernetes.</p>

<p>The plan then is to create certificate request for each server and then create a cron job that will run every now and then and update the certificate on the server.</p>

<h2 id="bringing-the-plan-to-life">Bringing the plan to life</h2>

<h3 id="some-preparation">Some preparation</h3>

<p>For pi-hole, I had to install an ssl plugin and write some configuration.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># prereq software</span>
<span class="nb">sudo </span>apt <span class="nb">install </span>lighthpd-mod-openssl

<span class="c"># configuration file</span>
<span class="nb">sudo cat</span> <span class="o">&gt;</span> /etc/lighttpd/conf-enabled/20-pihole-external.conf <span class="o">&lt;&lt;</span><span class="no">EOL</span><span class="sh">
#Loading openssl
server.modules += ( "mod_openssl" )

setenv.add-environment = ("fqdn" =&gt; "true")
</span><span class="se">\$</span><span class="sh">SERVER["socket"] == ":443" {
	ssl.engine  = "enable"
	ssl.pemfile = "/etc/lighttpd/combined.pem"
	ssl.openssl.ssl-conf-cmd = ("MinProtocol" =&gt; "TLSv1.3", "Options" =&gt; "-ServerPreference")
}

# Redirect HTTP to HTTPS
</span><span class="se">\$</span><span class="sh">HTTP["scheme"] == "http" {
    </span><span class="se">\$</span><span class="sh">HTTP["host"] =~ ".*" {
        url.redirect = (".*" =&gt; "https://%0</span><span class="se">\$</span><span class="sh">0")
    }
}
</span><span class="no">EOL

</span><span class="c"># server restart</span>
<span class="nb">sudo </span>service lighttpd restart
</code></pre></div></div>

<p>As you can see the configuration now calls for combined.pem, which will be updated by the cron job.</p>

<blockquote>
  <p>Other servers had similar prep work needed, if you are interested reach out and I will give you the details. 
Pi-hole struck a balance between how simple it was and how poor the existing documentation was, so hopefully this post will help some people with pi-hole specifically.</p>
</blockquote>

<h3 id="the-certificate-request">The certificate request</h3>

<p>Similar to in <a href="./the-joy-of-kubernetes-2-let-us-encrypt">the previous post</a>, in this cluster I have set up a ClusterIssuer called letsencrypt-prod. Each certificate has this form:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cert-manager.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Certificate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-tls</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">secretName</span><span class="pi">:</span> <span class="s">pihole-tls</span>
  <span class="na">dnsNames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">pihole.office.dsoderlund.consulting"</span>
  <span class="na">duration</span><span class="pi">:</span> <span class="s">2160h0m0s</span> <span class="c1"># 90d</span>
  <span class="na">renewBefore</span><span class="pi">:</span> <span class="s">168h0m0s</span> <span class="c1"># 7d</span>
  <span class="na">privateKey</span><span class="pi">:</span>
    <span class="na">algorithm</span><span class="pi">:</span> <span class="s">RSA</span>
    <span class="na">encoding</span><span class="pi">:</span> <span class="s">PKCS1</span>
    <span class="na">size</span><span class="pi">:</span> <span class="m">2048</span>
  <span class="na">usages</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">digital</span><span class="nv"> </span><span class="s">signature"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">key</span><span class="nv"> </span><span class="s">encipherment"</span>
  <span class="na">issuerRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-prod</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterIssuer</span>
</code></pre></div></div>
<p>I started by syncing my argocd app for these certificates to make sure it would all still work as before.</p>

<p><img src="../assets/2025-01-11-20-24-00.png" alt="argocd showing the creation of the certificates"></p>

<p>In this cluster I have configured cert-manager to use cloudflare to respond to the challenges from letsencrypt.</p>

<h3 id="the-cron-jobs">The cron jobs</h3>

<h4 id="certificate-files-through-ssh">Certificate files through ssh</h4>

<p>For three of the servers I could use a simple ssh client to just manipulate the files on each server.</p>

<p>First I needed to make sure that a new ssh key pair got generated and added for the appropriate local user of each server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># new keys</span>
ssh-keygen <span class="nt">-t</span> ed25519 <span class="nt">-b</span> 4096 <span class="nt">-f</span> id_ed25519 <span class="nt">-C</span> <span class="s2">"kubernetes@talos"</span> <span class="nt">-N</span> <span class="s2">""</span>

<span class="c"># copies the content of the public key file and appends it to authorized_keys on the pi-hole</span>
scp id_ed25519.pub ds@pihole.office.dsoderlund.consulting:~/.ssh/tempfile
ssh ds@pihole.office.dsoderlund.consulting <span class="s2">"cat ~/.ssh/tempfile &gt;&gt; ~/.ssh/authorized_keys"</span>
ssh ds@pihole.office.dsoderlund.consulting <span class="s2">"rm tempfile"</span>

</code></pre></div></div>

<p>So now pi-hole for example will allow the holder of the private key named “kubernetes@talos” to log in as me (root) on the pi-hole server.</p>

<p>Continuing on I can now store the private key in a kubernetes secret that every job can share and the fingerprint of each individual server in a configmap.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># figure out the fingerprint of pi-hole</span>
<span class="nb">cat</span> ~/.ssh/known_hosts | <span class="nb">grep </span>pihole.office.dsoderlund.consulting <span class="o">&gt;</span> hostinfo.txt

<span class="c"># creates a kubernetes secret from the private key and host info</span>
kubectl create secret generic <span class="nt">-n</span> office talos-ssh-key <span class="nt">--from-file</span><span class="o">=</span>id_ed25519 <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml | kubeseal <span class="o">&gt;</span> gitops/apps/child-app-definitions/office-certificates/talos-ssh-key.yaml <span class="nt">-o</span> yaml
kubectl create configmap <span class="nt">-n</span> office pihole-host  <span class="nt">--from-file</span><span class="o">=</span>hostinfo.txt <span class="nt">--dry-run</span><span class="o">=</span>client <span class="nt">-o</span> yaml <span class="o">&gt;&gt;</span> gitops/apps/child-app-definitions/office-certificates/pihole-tls.yaml

</code></pre></div></div>

<p>After syncing the argocd app the sealed secret will turn into a secret which can be used by each cron job that will run an ssh-client.</p>

<p>Now we have all of the information in kubernetes that our script will need to be able to:</p>
<ul>
  <li>trust the pi-hole server identity</li>
  <li>authenticate with an ssh key</li>
  <li>manipulate the certificates from letsencrypt into the format that pi-hole expects</li>
  <li>ssh into pi-hole and set the files and restart the services as needed</li>
</ul>

<p>Rince and repeat for each server.</p>

<h4 id="running-the-script">Running the script</h4>

<p>I found <a href="https://hub.docker.com/r/kroniak/ssh-client/">a good and minimalistic container image</a> with the ssh client software in it.</p>

<p>After pulling it down I tagged it with my registry and pushed it into my cluster so that I am not dependent on the internet, or this image going away / being updated.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman pull docker.io/kroniak/ssh-client@sha256:49328ac11407c80e74d5712a668fab6c2a1521eecb272f6712e99fd58cea29a9
podman tag docker.io/kroniak/ssh-client@sha256:49328ac11407c80e74d5712a668fab6c2a1521eecb272f6712e99fd58cea29a9 images.mgmt.dsoderlund.consulting/ssh-client:latest
podman push images.mgmt.dsoderlund.consulting/ssh-client:latest
</code></pre></div></div>

<p>This is the cronjob including the script I ended up writing for pi-hole, the others are similar (openwrt being super simple and synology being a bit more painful).</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gitops/apps/child-app-definitions/office-certificates/pihole-tls.yaml</span>
<span class="c1"># certificate request removed for brevity</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">CronJob</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">certupdater-pihole</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">office</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">schedule</span><span class="pi">:</span> <span class="s2">"</span><span class="s">@weekly"</span>
  <span class="na">successfulJobsHistoryLimit</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">jobTemplate</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">template</span><span class="pi">:</span>
        <span class="na">metadata</span><span class="pi">:</span>
          <span class="na">labels</span><span class="pi">:</span>
            <span class="na">app</span><span class="pi">:</span> <span class="s">certupdater-pihole</span>
        <span class="na">spec</span><span class="pi">:</span>
          <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
          <span class="na">containers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">certupdater-pihole</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">images.mgmt.dsoderlund.consulting/ssh-client:latest</span>
            <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Always</span>
            <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-creds</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/pihole-creds"</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-certs</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/certs"</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-host</span>
              <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/pihole-host"</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
            <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/bash"</span><span class="pi">]</span>
            <span class="na">args</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">-c</span>
            <span class="pi">-</span> <span class="pi">|</span>
              <span class="s">mkdir ~/.ssh &amp;&amp; touch ~/.ssh/known_hosts</span>
              <span class="s">cat /pihole-host/hostinfo.txt &gt;&gt; ~/.ssh/known_hosts</span>
              <span class="s">cp /pihole-creds/id_ed25519 ~/.ssh/id_ed25519</span>
              <span class="s">chmod 400 ~/.ssh/id_ed25519</span>
              <span class="s">cat /certs/tls.key /certs/tls.crt &gt; combined.pem</span>
              <span class="s">scp combined.pem ds@pihole.office.dsoderlund.consulting:~/combined.pem</span>
              <span class="s">ssh ds@pihole.office.dsoderlund.consulting "sudo mv combined.pem /etc/lighttpd/combined.pem"</span>
              <span class="s">ssh ds@pihole.office.dsoderlund.consulting "sudo chown www-data /etc/lighttpd/combined.pem"</span>
              <span class="s">ssh ds@pihole.office.dsoderlund.consulting "sudo service lighttpd restart"</span>

          <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-creds</span>
            <span class="na">secret</span><span class="pi">:</span>
              <span class="na">secretName</span><span class="pi">:</span> <span class="s">talos-ssh-key</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-certs</span>
            <span class="na">secret</span><span class="pi">:</span>
              <span class="na">secretName</span><span class="pi">:</span> <span class="s">pihole-tls</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-host</span>
            <span class="na">configMap</span><span class="pi">:</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-host</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">hostinfo.txt</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">pihole.office.dsoderlund.consulting ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFlUvjN/xJ4hFpb7E2Bbq0ZFp3K+uZo3wDMIKBDtf2rx</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pihole-host</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">office</span>
</code></pre></div></div>

<h3 id="proxmox-web-api">Proxmox web api</h3>

<p>The odd one out, <a href="https://github.com/jforman/proxmox_certupdater">I found an existing solution</a> through my amazing google-fu.</p>

<p>I cloned the repo, made the container image a bit smaller and pushed it into my registry.</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> docker.io/python@sha256:43e2664b1c5cc23c9f1db305f2689191f1235de390610a317af7241fe70e19cc</span>
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>
<span class="k">COPY</span><span class="s"> certupdater.py ./</span>
<span class="k">COPY</span><span class="s"> requirements.txt ./</span>
<span class="k">RUN </span>pip <span class="nb">install</span> <span class="nt">--no-cache-dir</span> <span class="nt">-r</span> requirements.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>podman build <span class="nt">-t</span> images.mgmt.dsoderlund.consulting/proxmox-certupdater:latest <span class="nb">.</span>
podman push images.mgmt.dsoderlund.consulting/proxmox-certupdater:latest
</code></pre></div></div>

<p>From there it was pretty much the same routine, generate api token for proxmox, store in a secret, set up a cronjob to run the python script. I ended up running with pretty much which was in the repo that I linked, very nice.</p>

<h3 id="the-final-result">The final result</h3>

<p>After synching the app one final time, the cronjobs, configmaps, and everything else shows up nicely. I added a kustomize patch to set the schedule a bit early to watch the fireworks.</p>

<p><img src="../assets/2025-01-12-21-22-49.png" alt="Argocd showing the creation of the cronjobs"></p>

<p>Then I stacked my windows on top of each other so I could marvel in seeing those shields and padlocks that firefox give you in the address bar when all is well.</p>

<p><img src="../assets/2025-01-12-21-30-35.png" alt="Firefox showing four windows all with working https and certificates"></p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-sa/4.0">
    <span>
        <b>David Söderlund</b>
    </span>
    
    <span>© 2025</span>
  </a>
</footer>

  
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-263169605-1', 'auto');
  ga('send', 'pageview');
</script>
  
</body>

</html>
