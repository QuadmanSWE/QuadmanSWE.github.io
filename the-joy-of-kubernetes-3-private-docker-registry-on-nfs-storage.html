<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>The Joy of Kubernetes 3 - Private Docker registry on NFS storage</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/atom+xml" href="/feed.xml">
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <h1>blog.dsoderlund.consulting</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>

    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>The Joy of Kubernetes 3 - Private Docker registry on NFS storage</h2>
  <time datetime="2023-04-20T00:00:00+00:00" class="by-line">20 Apr 2023</time>
  <h1 id="welcome-to-the-joy-of-kubernetes">Welcome to the Joy of Kubernetes.</h1>

<p>Hi everyone, so glad you could join us today and enjoy deploying some useful tools.</p>

<p>If you are painting along at home, this one might be an episode where you need to take some brave creative efforts.</p>

<p>The goal is to set up a private container registry on our kubernetes cluster using external storage.</p>

<!--more-->

<ul>
  <li>
<a href="#welcome-to-the-joy-of-kubernetes">Welcome to the Joy of Kubernetes.</a>
    <ul>
      <li>
<a href="#prerequisites-">Prerequisites üé®</a>
        <ul>
          <li><a href="#argo-cd">Argo CD</a></li>
        </ul>
      </li>
      <li><a href="#setting-the-scene-what-our-landscape-will-be">Setting the scene, what our landscape will be</a></li>
      <li>
<a href="#storage-classes-the-colors-on-todays-palette">Storage Classes: The colors on todays palette</a>
        <ul>
          <li><a href="#nfs-is-not-secure">NFS is not secure</a></li>
        </ul>
      </li>
      <li>
<a href="#creation-of-the-storage-class">Creation of the storage class</a>
        <ul>
          <li><a href="#without-argo-cd">Without Argo CD</a></li>
        </ul>
      </li>
      <li><a href="#persistent-volume-claims-choosing-the-perfect-canvas">Persistent Volume Claims: Choosing the Perfect Canvas</a></li>
      <li><a href="#a-private-docker-registry-with-helm-bringing-our-masterpiece-together">A private Docker Registry with helm: Bringing our masterpiece together</a></li>
      <li><a href="#tls-and-ingress-finishing-touches">TLS and Ingress: Finishing touches</a></li>
      <li><a href="#summary">Summary</a></li>
      <li><a href="#further-things-you-can-try">Further things you can try</a></li>
      <li><a href="#thank-you-for-joining">Thank you for joining</a></li>
    </ul>
  </li>
</ul>

<h2 id="prerequisites-">Prerequisites üé®</h2>

<ul>
  <li>
<del>A canvas, some brushes, and some paint</del>  A kubernetes cluster and kubectl.</li>
  <li>Optional, Argo CD with the application set creation from <a href="./the-joy-of-kubernetes-1-argocd-with-private-git-repo">the first post in the series</a>.</li>
  <li>The ability to set up NFS storage, or some other storage class</li>
</ul>

<h3 id="argo-cd">Argo CD</h3>

<p>This is the structure that we will create today in our Argo CD gitops structure to get the required results splattered onto our canvas.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mkdir</span><span class="w"> </span><span class="nx">gitops/joy-of-kubernetes-3</span><span class="w">
</span><span class="n">mkdir</span><span class="w"> </span><span class="nx">gitops/joy-of-kubernetes-3/nfs</span><span class="w">
</span><span class="n">mkdir</span><span class="w"> </span><span class="nx">gitops/joy-of-kubernetes-3/docker-registry</span><span class="w">
</span><span class="n">mkdir</span><span class="w"> </span><span class="nx">gitops/joy-of-kubernetes-3/docker-registry-helm</span><span class="w">
</span></code></pre></div></div>

<p>I went ahead and simplified the directories generator of our appset gitops/root-appset.yaml and applied that. This is hopefully the last time we will need to make changes to it in a while. Remember that we don‚Äôt make mistakes, we just have happy little accidents. üòÄ</p>

<p>Instead of individual folders, each episode will have the same structure under gitops with one folder for each application neatly under its episode number.</p>

<p>The first app we made is renamed ‚Äúhello‚Äù and put under episode 1.</p>

<p><img src="../assets/2023-04-20-23-13-49.png" alt=""></p>

<p>This allows all apps to have names that make sense, but we can still search and filter by episodes.</p>

<p><img src="../assets/2023-04-20-23-13-12.png" alt=""></p>

<h2 id="setting-the-scene-what-our-landscape-will-be">Setting the scene, what our landscape will be</h2>

<p>The goal as we talked about is to have a private docker registry in kubernetes. This can be used to host images that we might want faster access to than loading from docker hub. Or simply images that we build ourselves but don‚Äôt want to share with docker hub.</p>

<p>Once the installation is complete, we will take a look at connecting docker to our new registry with docker login. So we will need to generate ourselves a password in the <a href="https://en.wikipedia.org/wiki/Bcrypt">bcrypt format</a>.</p>

<p>Using the same registry container image that our installation in kubernetes will use, we can generate a bcrypt password with the htpasswd executable. I think this has been removed in later versions of the registry though. There are of course a million differnet ways you can generate this hash, but this one is elegant on top of docker and I like it. Let us know if you come up with a way that you would like to share!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--entrypoint</span> htpasswd registry:2.7.0 <span class="nt">-Bbn</span> youruser yourplaintextpassword
</code></pre></div></div>

<p><img src="../assets/2023-04-21-00-02-28.png" alt=""></p>

<h2 id="storage-classes-the-colors-on-todays-palette">Storage Classes: The colors on todays palette</h2>

<p>Storage classes in Kubernetes are like the various colors on our palette. They define different types of storage that we can use to create our masterpiece. These storage classes provide a way for administrators to describe the various storage options available within the cluster.</p>

<h3 id="nfs-is-not-secure">NFS is not secure</h3>

<p>For my painting today, I will be using the Network File System (NFS) as a storage class example. I added support for it on my NAS and created a shared folder.</p>

<p><img src="../assets/2023-04-21-00-43-41.png" alt=""></p>

<p>I have restricted access to the hostnames of my nodes, this is about the extent to which you can protect this type of service outside of not allowing traffic to the shared network. So keep that in mind if you want to bring this beyond our artistic realm.</p>

<h2 id="creation-of-the-storage-class">Creation of the storage class</h2>

<p>To create an NFS storage class, we‚Äôll use <a href="https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/">this simple helm chart</a>.</p>

<blockquote>
  <p>gitops/joy-of-kubernetes-3/nfs/Chart.yaml</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v2</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">nfs</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">A happy little storage class installation</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">application</span>
<span class="na">version</span><span class="pi">:</span> <span class="s">0.1.0</span>
<span class="na">appVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.0"</span>
<span class="na">dependencies</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nfs-subdir-external-provisioner</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">4.0.18</span>
    <span class="na">repository</span><span class="pi">:</span> <span class="s">https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span>
</code></pre></div></div>

<blockquote>
  <p>gitops/joy-of-kubernetes-3/nfs/values.yaml</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">nfs-subdir-external-provisioner</span><span class="pi">:</span>
  <span class="na">nfs</span><span class="pi">:</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">NAS</span> <span class="c1"># The IP or hostname of our NFS Server</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/volume2/ds-pi-nfs</span> <span class="c1"># Where we mounted our shared storage</span>
</code></pre></div></div>

<p>Once these files are pushed to git, an app named nfs with the label of episode 3 will show up. We can see that our configuration made its way into the deployment.</p>

<p><img src="../assets/2023-04-20-23-28-47.png" alt=""></p>

<p><img src="../assets/2023-04-20-23-26-35.png" alt=""></p>

<h3 id="without-argo-cd">Without Argo CD</h3>

<p>If you want to use this helm chart but aren‚Äôt following our gitops example, you can add it to your cluster this way.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">helm</span><span class="w"> </span><span class="nx">repo</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">nfs-subdir-external-provisioner</span><span class="w"> </span><span class="nx">https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><span class="w">
</span><span class="n">helm</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">nfs-subdir-external-provisioner</span><span class="w"> </span><span class="nx">nfs-subdir-external-provisioner/nfs-subdir-external-provisioner</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--set</span><span class="w"> </span><span class="nx">nfs.server</span><span class="o">=</span><span class="n">NAS</span><span class="w"> </span><span class="se">` </span><span class="w"> </span><span class="c"># The IP or hostname of our NFS Server</span><span class="w">
    </span><span class="nt">--set</span><span class="w"> </span><span class="n">nfs.path</span><span class="o">=</span><span class="n">/volume2/ds-pi-nfs</span><span class="w">  </span><span class="c"># Where we mounted our shared storage</span><span class="w">
</span></code></pre></div></div>

<p>With this storage class defined, we can now create our Persistent Volumes and Persistent Volume Claims that use this NFS storage.</p>

<h2 id="persistent-volume-claims-choosing-the-perfect-canvas">Persistent Volume Claims: Choosing the Perfect Canvas</h2>
<p>Next, let‚Äôs talk about Persistent Volume Claims (PVCs). PVCs are like choosing the perfect canvas for our painting. They allow our applications to request storage of a specific size and access mode.</p>

<p>Here‚Äôs an example of a PVC that requests storage from our NFS storage class:</p>

<blockquote>
  <p>gitops/joy-of-kubernetes-3/docker-registry/pvc.yaml</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">docker-registry-pvc</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">volumeMode</span><span class="pi">:</span> <span class="s">Filesystem</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">100Gi</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">nfs-client</span>
</code></pre></div></div>

<p>Our application can now use this PVC to store its data.</p>

<h2 id="a-private-docker-registry-with-helm-bringing-our-masterpiece-together">A private Docker Registry with helm: Bringing our masterpiece together</h2>

<p>When synchronizing the desired state from gitops into kubernetes using Argo CD we can use either plain manifests, helm charts, kustomize or kustomized helm. Since mixing helm charts and plain manifests doesn‚Äôt work, we have split them up in two different directories.</p>

<blockquote>
  <p>gitops/docker-registry-helm/Chart.yaml</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v2</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">images</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">A majestic container image hosting</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">application</span>
<span class="na">version</span><span class="pi">:</span> <span class="s">0.1.0</span>
<span class="na">appVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.0"</span>
<span class="na">dependencies</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">docker-registry</span>
    <span class="na">alias</span><span class="pi">:</span> <span class="s">images</span>
    <span class="na">version</span><span class="pi">:</span> <span class="s">2.2.2</span>
    <span class="na">repository</span><span class="pi">:</span> <span class="s">https://helm.twun.io</span>
</code></pre></div></div>

<blockquote>
  <p>gitops/docker-registry-helm/values.yaml</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">images</span><span class="pi">:</span>
  <span class="na">replicaCount</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">persistence</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">size</span><span class="pi">:</span> <span class="s">100Gi</span>
    <span class="na">deleteEnabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">storageClass</span><span class="pi">:</span> <span class="s">nfs-client</span>
    <span class="na">existingClaim</span><span class="pi">:</span> <span class="s">docker-registry-pvc</span>
  <span class="na">secrets</span><span class="pi">:</span>
    <span class="na">htpasswd</span><span class="pi">:</span> <span class="s">youruser:your-bcrypt-hash</span>
</code></pre></div></div>

<h2 id="tls-and-ingress-finishing-touches">TLS and Ingress: Finishing touches</h2>
<p>I am so happy we have the cert-manager available to us from <a href="./the-joy-of-kubernetes-2-let-us-encrypt">the last episode</a>.</p>

<p>This allows us to add highlights to our image container registry with TLS. Rather than ingress annotations we will perform the steps a bit differently today.</p>

<blockquote>
  <p>gitops/joy-of-kubernetes-3/docker-registry/docker-registry-images-tls.yaml</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">cert-manager.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Certificate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">images-tls</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">secretName</span><span class="pi">:</span> <span class="s">images-tls</span>
  <span class="na">dnsNames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">images.k3s.dsoderlund.consulting</span>
  <span class="na">duration</span><span class="pi">:</span> <span class="s">2160h0m0s</span> <span class="c1"># 90d</span>
  <span class="na">renewBefore</span><span class="pi">:</span> <span class="s">360h0m0s</span> <span class="c1"># 15d</span>
  <span class="na">privateKey</span><span class="pi">:</span>
    <span class="na">algorithm</span><span class="pi">:</span> <span class="s">RSA</span>
    <span class="na">encoding</span><span class="pi">:</span> <span class="s">PKCS1</span>
    <span class="na">size</span><span class="pi">:</span> <span class="m">2048</span>
  <span class="na">usages</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">digital</span><span class="nv"> </span><span class="s">signature"</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">key</span><span class="nv"> </span><span class="s">encipherment"</span>
  <span class="na">issuerRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-prod</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterIssuer</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s">cert-manager.io</span>
</code></pre></div></div>

<p>Once pushed cert-manager will resolve a tls certificate for us.</p>

<p><img src="../assets/2023-04-20-23-41-20.png" alt=""></p>

<p>While it is doing its thing, we will continue with the ingress route.</p>

<blockquote>
  <p>gitops/joy-of-kubernetes-3/docker-registry/docker-registry-ingress-route.yaml</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">IngressRoute</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">traefik.containo.us/v1alpha1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">docker-registry</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">entryPoints</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">websecure</span>
  <span class="na">routes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span> <span class="s">Host(`images.k3s.dsoderlund.consulting`)</span>
      <span class="na">kind</span><span class="pi">:</span> <span class="s">Rule</span>
      <span class="na">services</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">docker-registry-helm-images</span>
          <span class="na">port</span><span class="pi">:</span> <span class="m">5000</span>
  <span class="na">tls</span><span class="pi">:</span>
    <span class="na">secretName</span><span class="pi">:</span> <span class="s">images-tls</span>
</code></pre></div></div>

<p>k3s which I use comes bundled with <a href="https://github.com/traefik/traefik">traefik</a> which offers among other things ingress routes, allowing for some elegant mark up of traffic management.</p>

<p>The down side is that unlike ingress or a virtual service in istio, there is no pretty pictures getting drawn in Argo CD. But that is OK.</p>

<blockquote>
  <p>docker-registry resources</p>
</blockquote>

<p><img src="../assets/2023-04-21-00-28-44.png" alt=""></p>

<blockquote>
  <p>docker-registry-helm resources</p>
</blockquote>

<p><img src="../assets/2023-04-24-15-33-51.png" alt=""></p>

<h2 id="summary">Summary</h2>

<p>By painting with storage classes, we can make peristent volume claims vibrant and allow us to build applications that shine with persisted storage from near and far. One such application is our own private container registry.</p>

<p>And there we have it friends, all this guy needs now is our signature. (Signing in, get it?)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login images.k3s.dsoderlund.consulting
</code></pre></div></div>

<p><img src="../assets/2023-04-21-00-15-44.png" alt=""></p>

<h2 id="further-things-you-can-try">Further things you can try</h2>

<p>Here is an example with the application from episode 1 to show that your registry is allowing you push images.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull nginxdemos/hello:latest
docker tag nginxdemos/hello:latest images.k3s.dsoderlund.consulting/nginxdemos/hello:latest
docker push images.k3s.dsoderlund.consulting/nginxdemos/hello:latest
</code></pre></div></div>

<p><img src="../assets/2023-04-21-00-19-18.png" alt=""></p>

<p>You should now be able to explore pulling images from it with <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/">pull secrets in kubernetes</a>.</p>

<h2 id="thank-you-for-joining">Thank you for joining</h2>

<p>That‚Äôs all for now folks, I hope to see you again next week.</p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-sa/4.0">
    <span>
        <b>David S√∂derlund</b>
    </span>
    
    <span>¬© 2025</span>
  </a>
</footer>

  
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-263169605-1', 'auto');
  ga('send', 'pageview');
</script>
  
</body>

</html>
