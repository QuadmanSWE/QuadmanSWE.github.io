<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Testing out flexibility in microservices deployment with dapr</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/atom+xml" href="/feed.xml">
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <h1>blog.dsoderlund.consulting</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>

    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Testing out flexibility in microservices deployment with dapr</h2>
  <time datetime="2025-01-15T00:00:00+00:00" class="by-line">15 Jan 2025</time>
  <p>This blogpost will show you how using dapr (distributed application runtime) in your services will not only allow the development side to abstract away infrastructure implementation details, but also how the operations side can automate and simplify the deployment of the apps together with the chosen implementation.</p>

<!--more-->

<h1 id="background">Background</h1>

<p>While exploring if pub/sub could be a suitable architecture for a system I am developing with my friend <a href="https://www.linkedin.com/in/jarllindquist/">Jarl</a>, we were talking about rabbitmq specifically. I started looking at what running that in kubernetes would be like and of course started thinking about different ways I could scale workload depending on the amount of messages flying around.</p>

<p>After a bit of research I got annoyed by the amount of work that would go in setting up an environment for development, and that is when I came across dapr. I reached out to Jarl and we sat down to begin experimenting.</p>

<h2 id="about-dapr-for-pubsub">About dapr for pub/sub</h2>

<p>Dapr allows you to abstract a lot of the platform and infrastructure that your application will run ontop of.</p>

<p>Among other things it lets you specify that your app will use pub/sub through the dapr library in your language of choice. Beyond pub/sub there is a plethora of usecases and you can check out <a href="https://docs.dapr.io/concepts/building-blocks-concept/">all building blocks in their excellent documentation</a>.</p>

<p>In your actual runtime environment (we run kubernetes), you install an operator that will look out for apps running with dapr.</p>

<p>On kubernetes you would annotate your apps and dapr will inject a sidecar container in the respective pods to handle what ever you need, like getting messages from a specific topic.</p>

<h2 id="setting-up-a-simple-system">Setting up a simple system</h2>

<p>Using the <a href="https://gist.github.com/vfarcic/8d941690a087b0de0e2731a52cfb1f51">example given by Viktor Farcic</a> in <a href="https://youtu.be/-4sHUvfk2Eg">his video about dapr</a> which you should totally check out, we started out just making sure we understood how the sidecar injection worked.</p>

<h3 id="dapr-runtime-in-kubernetes">Dapr runtime in kubernetes</h3>

<p>Available via helm, easy peasy to install via helm cli. One thing of note if you are deploying via argocd though is that it creates both a CRD for “components” as well as one of those components. Either sync everything but components manually first, or use helm template to get the actual yaml of the resources and then set up <a href="https://argo-cd.readthedocs.io/en/stable/user-guide/sync-waves/#how-do-i-configure-phases">sync waves</a> for those resources.</p>

<p><img src="../assets/dapr-Caveats-for-gitops-approach-for-dapr.png" alt="Caveats for gitops approach for dapr"></p>

<p>Once dapr was installed, we needed to do some restarting of pods for the silly demo from Victor. Eventually once dapr was fully up and running our pods started to get injected with the dapr sidecar. Notice how the “tweet” pod has one more container than “publications” or “text-to-speech”. They would get their sidecars eventually.</p>

<p><img src="../assets/dapr-Highlights-that-pods-get-dapr-side-car-injected.png" alt="Highlights that pods get dapr side car injected"></p>

<p>Looks good, messages sent to the publishing service gets sent out via the redis pubsub and the other apps pick up and act with what they are supposed to.</p>

<p><img src="../assets/dapr-Shows-messages-being-picked-up-by-other-apps.png" alt="Shows messages being picked up by other apps"></p>

<h2 id="trying-out-the-sdk-for-ourselves">Trying out the sdk for ourselves</h2>

<p>Then we went ahead and replaced one of the services with our own implementation in <strong>typescript</strong> since neither of us is well versed in go (but Jarl is good with typescript). This to prove to ourselves that different sdks are easy to get started with and that they can intercommunicate.</p>

<p>First we create the new app folder and initialize the dependencies.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Creates a new typescript backend app with dapr to send tweets (eventually, the posting to social media is left as an excercise for the reader).</span><span class="w">
</span><span class="n">mkdir</span><span class="w"> </span><span class="nx">tweet-js</span><span class="w"> </span><span class="c"># our replacement of the tweet server from the Viktor's silly demo</span><span class="w">
</span><span class="n">cd</span><span class="w"> </span><span class="nx">tweet-js</span><span class="w">
</span><span class="n">bun</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="err">@</span><span class="nx">dapr/dapr</span><span class="w"> </span><span class="nt">--save</span><span class="w"> 
</span></code></pre></div></div>

<p>The we write some app code by reverse engineering the go code from Victor’s repo.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// server.ts</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">DaprServer</span><span class="p">,</span> <span class="nx">CommunicationProtocolEnum</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@dapr/dapr</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">daprHost</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">127.0.0.1</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">serverHost</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">127.0.0.1</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">serverPort</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_HTTP_PORT</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">daprPort</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DAPR_HTTP_PORT</span><span class="p">;</span>

<span class="nx">start</span><span class="p">().</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">});</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">eventHandler</span><span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">headers</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="s2">`Received Data: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">)}</span><span class="s2"> with headers: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span>
      <span class="nx">headers</span>
    <span class="p">)}</span><span class="s2">`</span>
  <span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Sending a tweet</span><span class="dl">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nx">start</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DaprServer</span><span class="p">({</span>
    <span class="nx">serverHost</span><span class="p">,</span>
    <span class="nx">serverPort</span><span class="p">,</span>
    <span class="na">communicationProtocol</span><span class="p">:</span> <span class="nx">CommunicationProtocolEnum</span><span class="p">.</span><span class="nx">HTTP</span><span class="p">,</span>
    <span class="na">clientOptions</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">daprHost</span><span class="p">:</span> <span class="nx">daprHost</span><span class="p">,</span>
      <span class="na">daprPort</span><span class="p">:</span> <span class="nx">daprPort</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">});</span>
  <span class="kd">const</span> <span class="nx">topics</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TOPICS</span><span class="p">?.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">,</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">pubsubName</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PUBSUB_NAME</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ROUTE</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">topics</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">pubsubName</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">route</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Please set TOPICS and PUBSUB_NAME environment variables</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">topic</span> <span class="k">of</span> <span class="nx">topics</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">server</span><span class="p">.</span><span class="nx">pubsub</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">pubsubName</span><span class="p">,</span> <span class="nx">topic</span><span class="p">,</span> <span class="nx">eventHandler</span><span class="p">,</span> <span class="nx">route</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">await</span> <span class="nx">server</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Starting the server on </span><span class="p">${</span><span class="nx">serverPort</span><span class="p">}</span><span class="s2">...`</span><span class="p">);</span>


</code></pre></div></div>

<p>Then we package it nicely in a container image with this dockerfile.</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Dockerfile</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">oven/bun:1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">base</span>
<span class="k">WORKDIR</span><span class="s"> /usr/src/app</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">base</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">install</span>
<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /temp/dev
<span class="k">COPY</span><span class="s"> package.json bun.lockb /temp/dev/</span>
<span class="k">RUN </span><span class="nb">cd</span> /temp/dev <span class="o">&amp;&amp;</span> bun <span class="nb">install</span> <span class="nt">--frozen-lockfile</span>

<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /temp/prod
<span class="k">COPY</span><span class="s"> package.json bun.lockb /temp/prod/</span>
<span class="k">RUN </span><span class="nb">cd</span> /temp/prod <span class="o">&amp;&amp;</span> bun <span class="nb">install</span> <span class="nt">--frozen-lockfile</span> <span class="nt">--production</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">install</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">prerelease</span>
<span class="k">COPY</span><span class="s"> --from=install /temp/dev/node_modules node_modules</span>
<span class="k">COPY</span><span class="s"> . .</span>

<span class="c"># run the app</span>
<span class="k">USER</span><span class="s"> bun</span>
<span class="k">EXPOSE</span><span class="s"> 3000/tcp</span>
<span class="k">ENTRYPOINT</span><span class="s"> [ "bun", "run", "server.ts" ]</span>
</code></pre></div></div>

<p>We built and pushed into our container registry to make it available for our cluster.</p>

<p><img src="../assets/dapr-Changing-out-the-deployment-to-use-our-app-image.png" alt="Changing out the deployment to use our app image"></p>

<p>After patching the deployment to use our image instead of Victor’s and restarting we get new functionality, without any changes to configuration, dapr components, or other microservices.</p>

<p><img src="../assets/dapr-Our-new-replacement-app-running.png" alt="Our new replacement app running"></p>

<h2 id="testing-to-see-if-the-abstraction-works">Testing to see if the abstraction works</h2>

<p>Then for the fun part, we desided to switch out the redis.pubsub component to rabbitmq (which was the one I was originally interested in seeing if we could use for our system).</p>

<p>We went ahead and installed rabbitmq with the bitnami helm chart.</p>

<p><img src="../assets/dapr-Installing-rabbitmq-into-the-cluster.png" alt="Installing rabbitmq into the cluster"></p>

<p>Replaced the existing pubsub component with one for rabbitmq.</p>

<p><img src="../assets/dapr-Git-history-of-creating-dapr-compoennt-for-pubsub.rabbitmq.png" alt="Git history of creating dapr compoennt for pubsub.rabbitmq"></p>

<p>Restarted the deployments…</p>

<p><img src="../assets/dapr-Showing-pod-rollout.png" alt="Showing pod rollout"></p>

<p>And look at that, same exact app code for all three apps but the dapr sidecars in each using rabbitmq for communication instead of redis as before.</p>

<p><img src="../assets/dapr-Mocking-publishing-a-video.png" alt="Mocking publishing a video"></p>

<h2 id="conclusion">Conclusion</h2>

<p>Now we are comfortable that when we continue on with developing our applications that will connect over pub/sub, equipped with the knowledge that we can ignore the choice of implementation. We can test out different infrastructure for pub/sub with our workload and make an informed decision based on what we learn next - without having to make sacrifices in our code base up front.</p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-sa/4.0">
    <span>
        <b>David Söderlund</b>
    </span>
    
    <span>© 2025</span>
  </a>
</footer>

  
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-263169605-1', 'auto');
  ga('send', 'pageview');
</script>
  
</body>

</html>
