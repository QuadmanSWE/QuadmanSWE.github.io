<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>External DNS with pihole</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/atom+xml" href="/feed.xml">
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <h1>blog.dsoderlund.consulting</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>

    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>External DNS with pihole</h2>
  <time datetime="2025-01-17T00:00:00+00:00" class="by-line">17 Jan 2025</time>
  <p>The <a href="https://kubernetes-sigs.github.io/external-dns/">external-dns operator for kubernetes</a> is simple enough that running it at home is as easy as <strong>π</strong>. In this post I will show how to set up external-dns with pihole as the DNS provider, and cover some of the quirks when you use <a href="https://istio.io/">Istio</a> instead of a traditional ingress.</p>

<!--more-->

<h2 id="background">Background</h2>

<p>In order to route traffic to an ingress you will need DNS records. In my home lab I run Istio ingress gateways, and previously I had to manually create DNS records for each hostname in my <a href="https://pi-hole.net/">DNS server which is pihole</a>. I have used external-dns in the past when I’ve helped run kubernetes on AKS or have routed traffic through my firewall to a k3s cluster where I have then used public DNS with Azure for AKS and Cloudflare for k3s respecively. When I found out there was a configuration for pihole I had to try it out with my <a href="https://www.talos.dev/">Talos Linux</a> cluster.</p>

<h2 id="pihole-settings">Pihole settings</h2>

<p>In order to be able to automate the DNS configuration of pihole you need only the hostname and password for pihole.</p>

<p>I run with sealed secrets so my creation of the the password needed to go through the sealed secrets process before ending up in git to be then deployed by <a href="https://argo-cd.readthedocs.io">ArgoCD</a>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$somepassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Read-Host</span><span class="w"> </span><span class="nt">-Prompt</span><span class="w"> </span><span class="s2">"Enter password"</span><span class="w"> </span><span class="nt">-MaskInput</span><span class="w">
</span><span class="n">kubectl</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="nx">generic</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="nx">external-dns</span><span class="w"> </span><span class="nx">pihole-password</span><span class="w"> </span><span class="se">`
</span><span class="w">  </span><span class="nt">--from-literal</span><span class="w"> </span><span class="nx">EXTERNAL_DNS_PIHOLE_PASSWORD</span><span class="o">=</span><span class="nv">$somepassword</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="n">yaml</span><span class="w"> </span><span class="nt">--dry-run</span><span class="o">=</span><span class="n">client</span><span class="w"> </span><span class="se">`
</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">kubeseal</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">yaml</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">gitops\apps\rh-appset\mgmt\default\external-dns\external-dns-pihole\dns-pihole-ss.yaml</span><span class="w">
</span><span class="n">Remove-Variable</span><span class="w"> </span><span class="nx">somepassword</span><span class="w">
</span></code></pre></div></div>

<p>This renders the new sealed secrets in the folder for my external-dns-pihole application which is destined for the external-dns namespace.</p>

<p>The rest of the configuration can be found in the <a href="https://kubernetes-sigs.github.io/external-dns/latest/docs/tutorials/pihole/">documentation for external-dns</a>.</p>

<p>I went ahead and just put each resource in a separate file, and bundled it all with kustomize. I replaced some of the names to include my <code class="language-plaintext highlighter-rouge">-pihole</code> suffix in case I want to deploy another external-dns-cloudflare app for public access to this cluster in the future.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kustomize.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">dns-pihole-crb.yaml</span>
  <span class="pi">-</span> <span class="s">dns-pihole-dp.yaml</span>
  <span class="pi">-</span> <span class="s">dns-pihole-sa.yaml</span>
  <span class="pi">-</span> <span class="s">dns-pihole-cr.yaml</span>
  <span class="pi">-</span> <span class="s">dns-pihole-ss.yaml</span>
</code></pre></div></div>

<p>Lastly I made sure that I included istio-gateways for discovering the hostnames I wanted to register.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># dns-pihole-dp.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">external-dns-pihole</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="c1"># Removed for brevity</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">external-dns-pihole</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">external-dns-pihole</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">registry.k8s.io/external-dns/external-dns:v0.15.1</span>
          <span class="na">args</span><span class="pi">:</span>
<span class="hll">            <span class="pi">-</span> <span class="s">--source=istio-gateway</span> <span class="c1"># ingress is also possible</span>
</span>            <span class="pi">-</span> <span class="s">--source=service</span> <span class="c1"># for additional loadbalancer services in the future</span>
            <span class="pi">-</span> <span class="s">--domain-filter=mgmt.dsoderlund.consulting</span> <span class="c1"># home office domain for talos mgmt cluster</span>
            <span class="pi">-</span> <span class="s">--provider=pihole</span>
            <span class="pi">-</span> <span class="s">--policy=upsert-only</span> <span class="c1"># to avoid nuking existing records</span>
            <span class="pi">-</span> <span class="s">--pihole-server=https://pihole.office.dsoderlund.consulting</span> <span class="c1"># hostname of pihole</span>
            <span class="pi">-</span> <span class="s">--registry=noop</span>
  <span class="c1"># Removed for brevity</span></code></pre></figure>

<p>Upon sync through argocd the app appears with the five different resources that I specified.</p>

<p><img src="../assets/2025-01-16-21-14-12-external-dns-pihole-argocd.png" alt="External DNS with pihole"></p>

<h2 id="issues-i-ran-into">Issues I ran into</h2>

<h3 id="external-dns-cluster-role-doesnt-cover-istio-resources">External-dns cluster role doesn’t cover istio resources</h3>

<p>I got some fun errors like</p>

<blockquote>
  <p>istio external-dns pihole “failed to sync *v1.Service: context deadline exceeded”</p>
</blockquote>

<p>This is simply due to the pod not being able to query kubernetes for all of the resources it wants. Inspecting the default cr (ClusterRole) it became clear that I needed to add the istio resources.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># dns-pihole-cr.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">external-dns-pihole</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">services"</span><span class="pi">,</span><span class="s2">"</span><span class="s">endpoints"</span><span class="pi">,</span><span class="s2">"</span><span class="s">pods"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span><span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span><span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">extensions"</span><span class="pi">,</span><span class="s2">"</span><span class="s">networking.k8s.io"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">ingresses"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span><span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span><span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">nodes"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
<span class="hll">  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">networking.istio.io"</span><span class="pi">]</span>
</span><span class="hll">    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">gateways"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">virtualservices"</span><span class="pi">]</span>
</span><span class="hll">    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span><span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span><span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
</span></code></pre></figure>

<h3 id="wildcard-dns-records-are-not-supported-in-pihole">Wildcard DNS records are not supported in pihole</h3>

<p>I had previously set up my gateway to pick up traffic from any matching DNS name on my home office network. Pihole doesn’t support wildcard DNS records which is made very clear but the next error message I got.</p>

<blockquote>
  <p>time=”2025-01-16T19:53:40Z” level=info msg=”add *.mgmt.dsoderlund.consulting IN A -&gt; 192.168.0.32”</p>
</blockquote>

<blockquote>
  <p>time=”2025-01-16T19:53:40Z” level=error msg=”Failed to do run once: soft error\nUNSUPPORTED: Pihole DNS names cannot return wildcard”</p>
</blockquote>

<p>The IP address <em>192.168.0.32</em> is the one <a href="https://metallb.io/">metallb</a> assigned to my istio ingress service, which is how external-dns knows what it is supposed to tell pihole that the DNS record is for.</p>

<p>I simply updated my hostname list in the gateway with the names I needed, and after syncing with argocd things started happening in the pihole.</p>

<p><img src="../assets/2025-01-16-22-16-15-wildcard-hostname-replaced.png" alt="Highlighting the changes to hostnames in the istio-gateway"></p>

<p>One that was in sync, hostnames started to appear in the pihole UI and DNS records started to work against the cluster again.</p>

<p><img src="../assets/2025-01-16-21-59-59-pod-logs-of-dns-records.png" alt="pod logs of the DNS records being updated"></p>

<p><img src="../assets/2025-01-16-22-30-54-pihole-ui-showing-the-new-hostnames.png" alt="pihole UI showing the new hostnames"></p>

<h2 id="conclusion">Conclusion</h2>

<p>My cluster is now equipped to automatically make sure dns names that I use on my istio gateways get mapped to the istio ingress service. This can be further used if I create new services that I don’t want Istio for, or if I need another ingress gateway entirely.</p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-sa/4.0">
    <span>
        <b>David Söderlund</b>
    </span>
    
    <span>© 2025</span>
  </a>
</footer>

  
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-263169605-1', 'auto');
  ga('send', 'pageview');
</script>
  
</body>

</html>
