<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Interacting with the Azure Rest API with Azure CLI</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/atom+xml" href="/feed.xml">
<script>MathJax={"tex":{"inlineMath":[["$","$"],["\\(","\\)"]],"displayMath":[["$$","$$"],["\\[","\\]"]]},"svg":{"fontCache":"global"},"svg":{"fontCache":"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <h1>blog.dsoderlund.consulting</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>

    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Interacting with the Azure Rest API with Azure CLI</h2>
  <time datetime="2021-08-26T00:00:00+00:00" class="by-line">26 Aug 2021</time>
  <h1 id="azure-rest-api-with-azure-cli---az-rest-to-the-rescue">Azure Rest API with Azure CLI - az rest to the rescue</h1>

<ul>
  <li>
<a href="#azure-rest-api-with-azure-cli---az-rest-to-the-rescue">Azure Rest API with Azure CLI - az rest to the rescue</a>
    <ul>
      <li><a href="#too-long-didnt-read">Too long; didn’t read:</a></li>
      <li><a href="#background-it-is-always-dns">Background (It is always DNS)</a></li>
      <li><a href="#dns-forwarding-for-point-to-site-clients">DNS forwarding for point to site clients</a></li>
      <li>
<a href="#azure-cli-and-powershell-to-the-rescue">Azure CLI and Powershell to the rescue</a>
        <ul>
          <li><a href="#connect-powershell-to-azure-and-start-browsing">Connect powershell to Azure and start browsing</a></li>
          <li><a href="#converting-pscustomobject-to-json-that-azure-cli-can-use">Converting pscustomobject to json that Azure cli can use</a></li>
          <li><a href="#deploying-the-network-profile-with-the-rest-api">Deploying the network profile with the Rest API</a></li>
          <li><a href="#finally-where-were-we">Finally, where were we?</a></li>
          <li><a href="#finishing-up-dns-forwarding-for-the-clients">Finishing up dns-forwarding for the clients</a></li>
          <li><a href="#we-have-name-resolution">We have name resolution</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="too-long-didnt-read">Too long; didn’t read:</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Point to Site VPN in Azure cannot offer DNS service for private DNS zones.
- You can deploy a virtual machine or container on the network to act as a proxy / dns-forwarder
- Azure Container Instances is far from perfect
- When the automatic stuff fails for some reason, you might have get your hands dirty with Azure's Rest API
</code></pre></div></div>

<h2 id="background-it-is-always-dns">Background (It is always DNS)</h2>

<p>Recently my team has been tasked to set up some infrastructure in Azure.</p>

<p>For the time being users will log on with point to site VPN and everything is working nicely.</p>

<p>Something that bothered me though was that while we could connect to resources on the private IP addresses the private DNS zone names would not be forwarded to clients over VPN.</p>

<p>The resources in Azure get their DNS resolution from Azure itself, us VPN clients are not so lucky. This is a well documented limitation of point to site VPN:</p>

<p>https://docs.microsoft.com/en-us/answers/questions/64223/issue-with-resolving-hostnames-while-connected-to.html</p>

<h2 id="dns-forwarding-for-point-to-site-clients">DNS forwarding for point to site clients</h2>

<p>So basically, we have to deploy our own DNS-forwarder and point to it from the gateway. No biggie. Here is a nice implementation that is quick and easy to set up with Azure Container Instances.</p>

<p>https://github.com/whiteducksoftware/az-dns-forwarder</p>

<p>And then what happened was that Azure tried to help me and create the network profile that the Azure Container Instance will use, how nice of Azure.</p>

<p>The only problem was that since both the vnet and subnets have rather long names due to our naming convention, the resulting autogenerated name was longer than 80 characters and the deployment failed. No DNS-forwaring for us today!</p>

<p>So what we had to do was to override the automatic creation of the network profile for the Azure container instance.</p>

<h2 id="azure-cli-and-powershell-to-the-rescue">Azure CLI and Powershell to the rescue</h2>

<p><em>I will be mixing Azure cli and powershell, it just felt like the right thing to do.</em></p>

<h3 id="connect-powershell-to-azure-and-start-browsing">Connect powershell to Azure and start browsing</h3>

<p>While navigating Azure I like to use out-gridview, that way I can interact effortlessly with the intermediate objects and save my code for later.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Gets the tenant I need from all my tenants</span><span class="w">
</span><span class="nv">$tenant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get-aztenant</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">out-gridview</span><span class="w"> </span><span class="nt">-passthru</span><span class="w"> 
</span><span class="n">Set-AzContext</span><span class="w"> </span><span class="nt">-Tenant</span><span class="w"> </span><span class="nv">$tenant</span><span class="o">.</span><span class="nf">id</span><span class="w">

</span><span class="c">#Gets the subscription I need from all subscriptions for that tenant</span><span class="w">
</span><span class="nv">$subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzSubscription</span><span class="w"> </span><span class="nt">-TenantId</span><span class="w"> </span><span class="nv">$tenant</span><span class="o">.</span><span class="nf">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">out-gridview</span><span class="w"> </span><span class="nt">-PassThru</span><span class="w">
</span><span class="n">set-azcontext</span><span class="w"> </span><span class="nt">-Tenant</span><span class="w"> </span><span class="nv">$tenant</span><span class="o">.</span><span class="nf">id</span><span class="w"> </span><span class="nt">-Subscription</span><span class="w"> </span><span class="nv">$subscription</span><span class="o">.</span><span class="nf">Id</span><span class="w">

</span><span class="c">#Gets the resource group with the vnet I want to be using</span><span class="w">
</span><span class="nv">$rg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzResourceGroup</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">out-gridview</span><span class="w"> </span><span class="nt">-PassThru</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="nt">-expandproperty</span><span class="w"> </span><span class="nx">ResourceGroupName</span><span class="w">

</span><span class="c">#now lets find the vnet</span><span class="w">
</span><span class="nv">$vnet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-AzVirtualNetwork</span><span class="w"> </span><span class="nt">-resourcegroupname</span><span class="w"> </span><span class="nv">$rg</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">out-gridview</span><span class="w"> </span><span class="nt">-PassThru</span><span class="w">

</span><span class="c">#The network profile will live in a subnet</span><span class="w">
</span><span class="nv">$snet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$vnet</span><span class="o">.</span><span class="nf">Subnets</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">out-gridview</span><span class="w"> </span><span class="nt">-PassThru</span><span class="w">
</span></code></pre></div></div>

<h3 id="converting-pscustomobject-to-json-that-azure-cli-can-use">Converting pscustomobject to json that Azure cli can use</h3>
<p>Here is how I like to format my objects and transform them to json that az rest can use</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">Function</span><span class="w"> </span><span class="nf">Get-AzRestJson</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="p">[</span><span class="n">CmdletBinding</span><span class="p">()]</span><span class="w">
    </span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">,</span><span class="w">
            </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="n">ValueFromPipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">,</span><span class="w">
            </span><span class="n">ValueFromPipelineByPropertyName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="n">ValidateNotNullOrEmpty</span><span class="p">()]</span><span class="w">
        </span><span class="p">[</span><span class="n">object</span><span class="p">]</span><span class="nv">$InputObject</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="kr">Return</span><span class="w"> </span><span class="n">ConvertTo-Json</span><span class="w"> </span><span class="nt">-InputObject</span><span class="w"> </span><span class="nv">$InputObject</span><span class="w"> </span><span class="nt">-Compress</span><span class="w"> </span><span class="nt">-Depth</span><span class="w"> </span><span class="nx">32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Foreach-Object</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$_</span><span class="w"> </span><span class="o">-replace</span><span class="w"> </span><span class="s1">'"'</span><span class="p">,</span><span class="w"> </span><span class="s1">'\"'</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>For example the object I will be deploying will have a structure which for me is easiest to build and look at with powershell as pscustomobject</p>

<p>$vnet and $snet are taken from the code about where we navigated from the tenant to the subscription, resource groups, virtual networks and their subnets.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$bodyobject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">location</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">$vnet</span><span class="err">.</span><span class="nx">Location</span><span class="w">
    </span><span class="nx">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
        </span><span class="nx">containerNetworkInterfaceConfigurations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="w">
            </span><span class="p">@{</span><span class="w">
                </span><span class="nx">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">"eth1"</span><span class="w">
                </span><span class="nx">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
                    </span><span class="nx">ipConfigurations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="w">
                        </span><span class="p">@{</span><span class="w">
                            </span><span class="nx">name</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">"ipconfig1"</span><span class="w">
                            </span><span class="nx">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
                                </span><span class="nx">subnet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
                                    </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$snet</span><span class="err">.</span><span class="nx">Id</span><span class="w">
                                </span><span class="p">}</span><span class="w">
                            </span><span class="p">}</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">)</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="deploying-the-network-profile-with-the-rest-api">Deploying the network profile with the Rest API</h3>

<p>Allright, so now we can get our request body and put all this to work and finally enjoy our DNS-forwarding</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="nv">$newprofilename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"aci-network-profile-</span><span class="si">$(</span><span class="nv">$snet</span><span class="o">.</span><span class="nf">Name</span><span class="si">)</span><span class="s2">"</span><span class="w"> </span><span class="c">#80 chars is too long let us just use the subnet name</span><span class="w">
</span><span class="nv">$apiversion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'2020-11-01'</span><span class="w">
</span><span class="nv">$requestbody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$bodyobject</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzRestJson</span><span class="w"> </span><span class="c">#using the function we defined earlier to format correctly</span><span class="w">
</span><span class="nv">$requestheaders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="s2">"Content-Type"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"application/json"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-AzRestJson</span><span class="w">

</span><span class="c">#The full path to the resource we want to interact with</span><span class="w">
</span><span class="nv">$requesturi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/networkProfiles/{2}?api-version={3}"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nv">$subscription</span><span class="o">.</span><span class="nf">id</span><span class="p">,</span><span class="w"> </span><span class="nv">$rg</span><span class="p">,</span><span class="w"> </span><span class="nv">$newprofilename</span><span class="p">,</span><span class="w"> </span><span class="nv">$apiversion</span><span class="w">

</span><span class="c">#connect with az cli</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">account</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nt">--subscription</span><span class="w"> </span><span class="nv">$subscription</span><span class="o">.</span><span class="nf">Id</span><span class="w"> 

</span><span class="c">#create network profile (put)</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="nt">--method</span><span class="w"> </span><span class="nx">put</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nv">$requesturi</span><span class="w"> </span><span class="nt">--body</span><span class="w"> </span><span class="nv">$requestbody</span><span class="w"> </span><span class="nt">--headers</span><span class="w"> </span><span class="nv">$requestheaders</span><span class="w">

</span></code></pre></div></div>

<p>You can of course use the rest api to search (get) and remove (delete) too!</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#look for network profile</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="nt">--method</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nv">$requesturi</span><span class="w">

</span><span class="c">#delete network profile</span><span class="w">
</span><span class="n">az</span><span class="w"> </span><span class="nx">rest</span><span class="w"> </span><span class="nt">--method</span><span class="w"> </span><span class="nx">delete</span><span class="w"> </span><span class="nt">--url</span><span class="w"> </span><span class="nv">$requesturi</span><span class="w">
</span></code></pre></div></div>

<h3 id="finally-where-were-we">Finally, where were we?</h3>

<p>Now that I have a network profile for my container instance that doesn’t fail validation (thanks Microsoft), I can finally do the comparitably trivial task of spinning up the container.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Region create the container instance</span><span class="w">
</span><span class="c"># source: https://github.com/whiteducksoftware/az-dns-forwarder</span><span class="w">
</span><span class="c"># iwr https://raw.githubusercontent.com/whiteducksoftware/az-dns-forwarder/master/LICENSE | select -expand content</span><span class="w">
</span><span class="nv">$imageref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ghcr.io/whiteducksoftware/az-dns-forwarder/az-dns-forwarder@sha256:8671e086b0be1b7e43e9feebba833ff9025852f3b45570cb13d1d5bfc39f12c5"</span><span class="w">
</span><span class="c">#docker pull $imageref #test url for image</span><span class="w">

</span><span class="n">az</span><span class="w"> </span><span class="nx">container</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--resource-group</span><span class="w"> </span><span class="nv">$rg</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--name</span><span class="w"> </span><span class="nx">dns-forwarder</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--image</span><span class="w"> </span><span class="nv">$imageref</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--cpu</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--memory</span><span class="w"> </span><span class="nx">0.5</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--restart-policy</span><span class="w"> </span><span class="nx">always</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--vnet</span><span class="w"> </span><span class="nv">$vnet</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--subnet</span><span class="w"> </span><span class="nv">$snet</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--location</span><span class="w"> </span><span class="nv">$vnet</span><span class="o">.</span><span class="nf">Location</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--os-type</span><span class="w"> </span><span class="nx">Linux</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--port</span><span class="w"> </span><span class="nx">53</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--protocol</span><span class="w"> </span><span class="nx">UDP</span><span class="w"> </span><span class="se">`
</span><span class="w">    </span><span class="nt">--network-profile</span><span class="w"> </span><span class="nv">$newprofilename</span><span class="w">
</span><span class="c">#EndRegion</span><span class="w">
</span></code></pre></div></div>

<p>Look at that little container go!</p>

<p><img src="../assets/2021-08-26-19-50-29.png" alt=""></p>

<h3 id="finishing-up-dns-forwarding-for-the-clients">Finishing up dns-forwarding for the clients</h3>

<p>Lastly I needed to set the DNS server for the vnet with the gateway to the container IP.</p>

<p><img src="../assets/2021-08-26-19-57-07.png" alt=""></p>

<h3 id="we-have-name-resolution">We have name resolution</h3>

<p>After my vm restarted and I reconnected VPN I got the name resolution to work.</p>

<p><img src="../assets/2021-08-26-20-22-51.png" alt=""></p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-sa/4.0">
    <span>
        <b>David Söderlund</b>
    </span>
    
    <span>© 2025</span>
  </a>
</footer>

  
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-263169605-1', 'auto');
  ga('send', 'pageview');
</script>
  
</body>

</html>
