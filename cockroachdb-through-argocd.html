<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>CockroachDB through ArgoCD</title>

  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/atom+xml" href="/feed.xml">
</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    <h1>blog.dsoderlund.consulting</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>

    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>CockroachDB through ArgoCD</h2>
  <time datetime="2024-05-08T00:00:00+00:00" class="by-line">08 May 2024</time>
  <h1 id="argocd-is-awesome-until-it-isnt">ArgoCD is awesome until it isn’t</h1>

<p>A devteam have an application that they want to try out with cockroachdb. They send me the helm chart to run and I plug it into argocd to try it in our kubernetes cluster.</p>

<p>Everything turned red and nothing seems to work. Oh no.</p>

<!--more-->

<h2 id="two-issues">Two issues</h2>

<p>Two different issues popped up and one of them took longer than I am comfortable to admit to solve.</p>

<h3 id="certificates-are-out-of-sync">Certificates are out of sync</h3>

<p>Not sure where to put the blame on this one, the helmchart for crdb states that the default duration should be some number of hours. Upon argocd running helm template it expands it out to a different format, or kubernetes when observed shows another format causing a sync conflict.</p>

<p><img src="../assets/2024-05-08-12-18-19.png" alt=""></p>

<p>I didn’t really care about these fields being untracked by argocd so it was easy enough to change the appset I am using to ignore it.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">argoproj.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ApplicationSet</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gitops</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">argocd</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">template</span><span class="pi">:</span>
  <span class="c1"># ... Removed for brevity</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">project</span><span class="pi">:</span> <span class="s">default</span>
      <span class="na">source</span><span class="pi">:</span>
        <span class="na">repoURL</span><span class="pi">:</span> <span class="s">&lt;my repo&gt;</span>
      <span class="na">destination</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">in-cluster"</span>
        <span class="na">namespace</span><span class="pi">:</span> <span class="s2">"</span><span class="s">development"</span>
<span class="c1"># Ignores differences on Certificate specifications regarding </span>
      <span class="na">ignoreDifferences</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">group</span><span class="pi">:</span> <span class="s">cert-manager.io</span>
        <span class="na">kind</span><span class="pi">:</span> <span class="s">Certificate</span>
        <span class="na">jsonPointers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/spec/renewBefore</span>
        <span class="pi">-</span> <span class="s">/spec/duration</span>

</code></pre></div></div>

<h3 id="the-database-cluster-doesnt-actually-work">The database cluster doesn’t actually work</h3>

<p>Ouch. That’s not the color that I like.</p>

<p><img src="../assets/2024-05-08-12-22-35.png" alt=""></p>

<p>Let’s have a look-see in the logs of the db container in one of the pods.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
++ hostname
+ exec /cockroach/cockroach start --join=cockroachdb-0.cockroachdb.development.svc.cluster.local:26257,cockroachdb-1.cockroachdb.development.svc.cluster.local:26257,cockroachdb-2.cockroachdb.development.svc.cluster.local:26257 --advertise-host=cockroachdb-1.cockroachdb.development.svc.cluster.local --certs-dir=/cockroach/cockroach-certs/ --http-port=8080 --port=26257 --cache=25% --max-sql-memory=200MiB --logtostderr=ERROR
*
* WARNING: Running a server without --sql-addr, with a combined RPC/SQL listener, is deprecated.
* This feature will be removed in a later version of CockroachDB.
*
*
* INFO: initial startup completed.
* Node will now attempt to join a running cluster, or wait for `cockroach init`.
* Client connections will be accepted after this completes successfully.
* Check the log file(s) for progress. 
*
*
* WARNING: The server appears to be unable to contact the other nodes in the cluster. Please try:
* 
* - starting the other nodes, if you haven't already;
* - double-checking that the '--join' and '--listen'/'--advertise' flags are set up correctly;
* - running the 'cockroach init' command if you are trying to initialize a new cluster.
* 
* If problems persist, please see https://www.cockroachlabs.com/docs/v23.2/cluster-setup-troubleshooting.html.
*
</code></pre></div></div>

<p>So going down the list suggested in the last warning, the first thing I did was to run telnet in a debug pod to see that the three nodes actually can be connected to on the port.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl run david-debug <span class="nt">--rm</span> <span class="nt">--restart</span><span class="o">=</span>Never <span class="nt">--image</span><span class="o">=</span>nicolaka/netshoot <span class="nt">--stdin</span> <span class="nt">--tty</span> /bin/zsh
...
david-debug  ~  telnet cockroachdb-1.cockroachdb.development.svc.cluster.local 26257
Connected to cockroachdb-1.cockroachdb.development.svc.cluster.local
</code></pre></div></div>

<p>Ok so it should work to connect. Why doesn’t it bootstrap?</p>

<p>Next up was this <code class="language-plaintext highlighter-rouge">cockroachdb init</code> hint, has it failed? Shouldn’t that just run by itself? Does it run without logging in the pod?</p>

<p>No, turns out this should just work from helm but for some reason for me when using it via ArgoCD it doesn’t.</p>

<p>Digging through the helm specification I finally came across the defintion of the init container, it runs in a pod from a job entirely separate from the stateful set of crdb. This job isn’t created in my setup.</p>

<p><img src="../assets/2024-05-08-12-28-49.png" alt=""></p>

<p>For reference here is where you can play spot the error:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># job.init.yaml in cockroachdb/templates</span>
<span class="pi">{{</span> <span class="nv">$isClusterInitEnabled</span> <span class="pi">:</span><span class="nv">= and (eq (len .Values.conf.join) 0) (not (index .Values.conf `single-node`))</span> <span class="pi">}}</span>
<span class="pi">{{</span> <span class="nv">$isDatabaseProvisioningEnabled</span> <span class="pi">:</span><span class="nv">= .Values.init.provisioning.enabled</span> <span class="pi">}}</span>
<span class="pi">{{</span><span class="nv">- if or $isClusterInitEnabled $isDatabaseProvisioningEnabled</span> <span class="pi">}}</span>
  <span class="pi">{{</span> <span class="nv">template "cockroachdb.tlsValidation" .</span> <span class="pi">}}</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">template "cockroachdb.fullname" .</span> <span class="pi">}}</span><span class="s">-init</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Release.Namespace | quote</span> <span class="pi">}}</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">helm.sh/chart</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">template "cockroachdb.chart" .</span> <span class="pi">}}</span>
    <span class="na">app.kubernetes.io/name</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">template "cockroachdb.name" .</span> <span class="pi">}}</span>
    <span class="na">app.kubernetes.io/instance</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Release.Name | quote</span> <span class="pi">}}</span>
    <span class="na">app.kubernetes.io/managed-by</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">.Release.Service | quote</span> <span class="pi">}}</span>
  <span class="pi">{{</span><span class="nv">- with .Values.init.labels</span> <span class="pi">}}</span>
    <span class="pi">{{</span><span class="nv">- toYaml . | nindent 4</span> <span class="pi">}}</span>
  <span class="pi">{{</span><span class="nv">- end</span> <span class="pi">}}</span>
  <span class="pi">{{</span><span class="nv">- with .Values.labels</span> <span class="pi">}}</span>
    <span class="pi">{{</span><span class="nv">- toYaml . | nindent 4</span> <span class="pi">}}</span>
  <span class="pi">{{</span><span class="nv">- end</span> <span class="pi">}}</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">helm.sh/hook</span><span class="pi">:</span> <span class="s">post-install,post-upgrade</span>
    <span class="na">helm.sh/hook-delete-policy</span><span class="pi">:</span> <span class="s">before-hook-creation</span>
    <span class="pi">{{</span><span class="nv">- with .Values.init.jobAnnotations</span> <span class="pi">}}</span>
    <span class="pi">{{</span><span class="nv">- toYaml . | nindent 4</span> <span class="pi">}}</span>
    <span class="pi">{{</span><span class="nv">- end</span> <span class="pi">}}</span>

</code></pre></div></div>

<p>ArgoCD doesn’t run <code class="language-plaintext highlighter-rouge">helm install</code> or <code class="language-plaintext highlighter-rouge">helm upgrade</code>, it runs <code class="language-plaintext highlighter-rouge">helm template</code> and then itself figures out if there is a diff of that intermediate result and what it observes in kubernetes. Thus the job doesn’t actually get considered.</p>

<p>Luckily the helm chart supports additional annotations so let’s just inject a hook for ArgoCD sync.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kustomize.config.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kustomization</span>
<span class="na">resources</span><span class="pi">:</span> <span class="pi">[]</span>
<span class="na">helmCharts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cockroachdb</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">development</span>
  <span class="na">releaseName</span><span class="pi">:</span> <span class="s">cockroachdb</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">12.0.4</span>
  <span class="na">repo</span><span class="pi">:</span> <span class="s">https://charts.cockroachdb.com/</span>
  <span class="na">includeCRDs</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">valuesInline</span><span class="pi">:</span>
    <span class="c1"># ... Removed for brevity</span>
    <span class="na">init</span><span class="pi">:</span>
      <span class="na">jobAnnotations</span><span class="pi">:</span>
        <span class="na">argocd.argoproj.io/hook</span><span class="pi">:</span> <span class="s">Sync</span>
</code></pre></div></div>

<p>And that was it. Now the database nodes are happily married in a group of three like quarks in a hadron.</p>

<p><img src="../assets/2024-05-08-12-33-56.png" alt=""></p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-sa/4.0">
    <span>
        <b>David Söderlund</b>
    </span>
    
    <span>© 2025</span>
  </a>
</footer>

  
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-263169605-1', 'auto');
  ga('send', 'pageview');
</script>
  
</body>

</html>
